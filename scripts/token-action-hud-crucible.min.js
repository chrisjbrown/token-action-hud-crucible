const e={ID:"token-action-hud-crucible"},t={ID:"token-action-hud-core"},i="2.0",s={actions:"actions",ability:"crucible.Ability",check:"tokenActionHud.crucible.check",condition:"tokenActionHud.crucible.condition",counter:"tokenActionHud.crucible.counter",effect:"crucible.Effect",exhaustion:"crucible.Exhaustion",feature:"TYPES.Item.feat",item:"tokenActionHud.crucible.item",save:"crucible.SAVE.Title.one",skill:"tokenActionHud.crucible.skill",spell:"TYPES.Item.spell",utility:"crucible.ActionUtil"},a={action:{group:"actions"},bonus:{group:"bonus-actions",icon:"fas fa-plus"},crew:{group:"crew-actions",icon:"fas fa-users"},day:{icon:"fas fa-hourglass-end"},hour:{icon:"fas fa-hourglass-half"},lair:{group:"lair-actions",icon:"fas fa-home"},minute:{icon:"fas fa-hourglass-start"},legendary:{group:"legendary-actions",icon:"fas fas fa-dragon"},reaction:{group:"reactions",icon:"fas fa-bolt"},reactiondamage:{group:"reactions",icon:"fas fa-bolt"},reactionmanual:{group:"reactions",icon:"fas fa-bolt"},special:{group:"special-actions",icon:"fas fa-star"},other:{group:"other-actions"}},n="systems/crucible/icons/svg/statuses/concentrating.svg",l={ID:"custom-crucible",COUNTERS:{character:"character-counters",group:"group-counters",npc:"npc-counters"}},o=["activeFeatures","passiveFeatures","backgroundFeatures","classFeatures","feats","monsterFeatures","raceFeatures","artificerInfusions","channelDivinity","defensiveTactics","eldritchInvocations","elementalDisciplines","fightingStyles","huntersPrey","kiAbilities","maneuvers","metamagicOptions","multiattacks","pactBoons","psionicPowers","runes","superiorHuntersDefense"],c={_1stLevelSpells:{id:"1st-level-spells",name:"tokenActionHud.crucible.1stLevelSpells",spellMode:1,type:"system"},_2ndLevelSpells:{id:"2nd-level-spells",name:"tokenActionHud.crucible.2ndLevelSpells",spellMode:2,type:"system"},_3rdLevelSpells:{id:"3rd-level-spells",name:"tokenActionHud.crucible.3rdLevelSpells",spellMode:3,type:"system"},_4thLevelSpells:{id:"4th-level-spells",name:"tokenActionHud.crucible.4thLevelSpells",spellMode:4,type:"system"},_5thLevelSpells:{id:"5th-level-spells",name:"tokenActionHud.crucible.5thLevelSpells",spellMode:5,type:"system"},_6thLevelSpells:{id:"6th-level-spells",name:"tokenActionHud.crucible.6thLevelSpells",spellMode:6,type:"system"},_7thLevelSpells:{id:"7th-level-spells",name:"tokenActionHud.crucible.7thLevelSpells",spellMode:7,type:"system"},_8thLevelSpells:{id:"8th-level-spells",name:"tokenActionHud.crucible.8thLevelSpells",spellMode:8,type:"system"},_9thLevelSpells:{id:"9th-level-spells",name:"tokenActionHud.crucible.9thLevelSpells",spellMode:9,type:"system"},abilities:{id:"abilities",name:"tokenActionHud.crucible.abilities",type:"system"},actions:{id:"actions",name:"tokenActionHud.crucible.actions",type:"system"},activeFeatures:{id:"active-features",name:"tokenActionHud.crucible.activeFeatures",type:"system"},artificerInfusions:{id:"artificer-infusions",name:"tokenActionHud.crucible.artificerInfusions",type:"system"},atWillSpells:{id:"at-will-spells",name:"tokenActionHud.crucible.atWillSpells",spellMode:"atwill",type:"system"},backgroundFeatures:{id:"background-features",name:"tokenActionHud.crucible.backgroundFeatures",type:"system"},bonusActions:{id:"bonus-actions",name:"tokenActionHud.crucible.bonusActions",type:"system"},cantrips:{id:"cantrips",name:"tokenActionHud.crucible.cantrips",spellMode:0,type:"system"},channelDivinity:{id:"channel-divinity",name:"tokenActionHud.crucible.channelDivinity",type:"system"},checks:{id:"checks",name:"tokenActionHud.crucible.checks",type:"system"},classFeatures:{id:"class-features",name:"tokenActionHud.crucible.classFeatures",type:"system"},combat:{id:"combat",name:"tokenActionHud.combat",type:"system"},conditions:{id:"conditions",name:"tokenActionHud.crucible.conditions",type:"system"},consumables:{id:"consumables",name:"TYPES.Item.consumablePl",type:"system"},containers:{id:"containers",name:"TYPES.Item.containerPl",type:"system"},counters:{id:"counters",name:"tokenActionHud.crucible.counters",type:"system"},crewActions:{id:"crew-actions",name:"tokenActionHud.crucible.crewActions",type:"system"},defensiveTactics:{id:"defensive-tactics",name:"tokenActionHud.crucible.defensiveTactics",type:"system"},eldritchInvocations:{id:"eldritch-invocations",name:"tokenActionHud.crucible.eldritchInvocations",type:"system"},elementalDisciplines:{id:"elemental-disciplines",name:"tokenActionHud.crucible.elementalDisciplines",type:"system"},equipment:{id:"equipment",name:"TYPES.Item.equipmentPl",type:"system"},equipped:{id:"equipped",name:"crucible.Equipped",type:"system"},exhaustion:{id:"exhaustion",name:"crucible.Exhaustion",type:"system"},feats:{id:"feats",name:"tokenActionHud.crucible.feats",type:"system"},fightingStyles:{id:"fighting-styles",name:"tokenActionHud.crucible.fightingStyles",type:"system"},huntersPrey:{id:"hunters-prey",name:"tokenActionHud.crucible.huntersPrey",type:"system"},innateSpells:{id:"innate-spells",name:"tokenActionHud.crucible.innateSpells",spellMode:"innate",type:"system"},kiAbilities:{id:"ki-abilities",name:"tokenActionHud.crucible.kiAbilities",type:"system"},lairActions:{id:"lair-actions",name:"tokenActionHud.crucible.lairActions",type:"system"},legendaryActions:{id:"legendary-actions",name:"tokenActionHud.crucible.legendaryActions",type:"system"},loot:{id:"loot",name:"TYPES.Item.lootPl",type:"system"},maneuvers:{id:"maneuvers",name:"tokenActionHud.crucible.maneuvers",type:"system"},metamagicOptions:{id:"metamagic-options",name:"tokenActionHud.crucible.metamagicOptions",type:"system"},monsterFeatures:{id:"monster-features",name:"tokenActionHud.crucible.monsterFeatures",type:"system"},multiattacks:{id:"multiattacks",name:"tokenActionHud.crucible.multiattacks",type:"system"},otherActions:{id:"other-actions",name:"tokenActionHud.crucible.otherActions",type:"system"},pactBoons:{id:"pact-boons",name:"tokenActionHud.crucible.pactBoons",type:"system"},pactSpells:{id:"pact-spells",name:"tokenActionHud.crucible.pactSpells",spellMode:"pact",type:"system"},passiveEffects:{id:"passive-effects",name:"crucible.EffectPassive",type:"system"},passiveFeatures:{id:"passive-features",name:"tokenActionHud.crucible.passiveFeatures",type:"system"},psionicPowers:{id:"psionic-powers",name:"tokenActionHud.crucible.psionicPowers",type:"system"},raceFeatures:{id:"race-features",name:"tokenActionHud.crucible.raceFeatures",type:"system"},reactions:{id:"reactions",name:"crucible.ReactionPl",type:"system"},rests:{id:"rests",name:"tokenActionHud.crucible.rests",type:"system"},runes:{id:"runes",name:"tokenActionHud.crucible.runes",type:"system"},saves:{id:"saves",name:"crucible.ClassSaves",type:"system"},skills:{id:"skills",name:"tokenActionHud.crucible.skills",type:"system"},superiorHuntersDefense:{id:"superior-hunters-defense",name:"tokenActionHud.crucible.superiorHuntersDefense",type:"system"},temporaryEffects:{id:"temporary-effects",name:"crucible.EffectTemporary",type:"system"},token:{id:"token",name:"tokenActionHud.token",type:"system"},tools:{id:"tools",name:"TYPES.Item.toolPl",type:"system"},unequipped:{id:"unequipped",name:"crucible.Unequipped",type:"system"},utility:{id:"utility",name:"tokenActionHud.utility",type:"system"},weapons:{id:"weapons",name:"TYPES.Item.weaponPl",type:"system"}},r="fas fa-sun",u={0:"fa-regular fa-circle",.5:"fa-regular fa-circle-half-stroke",1:"fa-solid fa-circle",2:"fa-regular fa-circle-dot"},p={common:"tokenActionHud.crucible.common",uncommon:"tokenActionHud.crucible.uncommon",rare:"tokenActionHud.crucible.rare",veryRare:"tokenActionHud.crucible.veryRare",legendary:"tokenActionHud.crucible.legendary",artifact:"tokenActionHud.crucible.artifact"},d="fas fa-circle-r",m=["cantrips","_1stLevelSpells","_2ndLevelSpells","_3rdLevelSpells","_4thLevelSpells","_5thLevelSpells","_6thLevelSpells","_7thLevelSpells","_8thLevelSpells","_9thLevelSpells","atWillSpells","innateSpells","pactSpells"];let h=null;Hooks.once("tokenActionHudCoreApiReady",(async t=>{h=class Utils{static capitalize(e){return e.replace(/\w\S*/g,(e=>e.charAt(0).toUpperCase()+e.substring(1).toLowerCase()))}static getSetting(i,s=null){let a=s??null;try{a=game.settings.get(e.ID,i)}catch{t.api.Logger.debug(`Setting '${i}' not found`)}return a}static async setSetting(i,s){try{s=await game.settings.set(e.ID,i,s),t.api.Logger.debug(`Setting '${i}' set to '${s}'`)}catch{t.api.Logger.debug(`Setting '${i}' not found`)}}}}));let y=null;Hooks.once("tokenActionHudCoreApiReady",(async e=>{y=class ActionHandler extends e.api.ActionHandler{featureActions=null;inventoryActions=null;spellActions=null;async buildSystemActions(t){this.actors=this.actor?[this.actor]:this.#e(),this.tokens=this.token?[this.token]:this.#t(),this.actor&&(this.items=e.api.Utils.sortItemsByName(this.#i(this.actor.items))),this.abbreviateSkills=h.getSetting("abbreviateSkills"),this.displaySpellInfo=h.getSetting("displaySpellInfo"),this.showItemsWithoutActivationCosts=h.getSetting("showItemsWithoutActivationCosts"),this.showUnchargedItems=h.getSetting("showUnchargedItems"),this.showUnequippedItems=h.getSetting("showUnequippedItems"),"npc"!==this.actor?.type||this.showUnequippedItems||(this.showUnequippedItems=h.getSetting("showUnequippedItemsNpcs")),this.showUnpreparedSpells=h.getSetting("showUnpreparedSpells"),this.activationgroupIds=["actions","bonus-actions","crew-actions","lair-actions","legendary-actions","reactions","other-actions"],"hero"===this.actor?.type||"adversary"===this.actor?.type?(this.inventorygroupIds=["equipped","consumables","containers","equipment","loot","tools","weapons","unequipped"],await this.#s()):"vehicle"===this.actor?.type?(this.inventorygroupIds=["consumables","equipment","tools","weapons"],await this.#a()):this.actor||await this.#n()}async#s(){await Promise.all([this.#l(),this.#o()]),this.#c(),this.#r()}async#a(){await Promise.all([this.#l(),this.#u(),this.#p(),this.#d()]),this.#m("ability","abilities"),this.#m("check","checks"),this.#m("save","saves"),this.#c(),this.#r()}async#n(){this.#m("ability","abilities"),this.#m("check","checks"),this.#m("save","saves"),this.#c(),await this.#l(),this.#h(),this.#y(),this.#r()}#m(t,i){const s=this.actor?.system.abilities||CONFIG.crucible.abilities;if(0===s.length)return;const a=Object.entries(s).filter((e=>0!==s[e[0]].value)).map((([a,n])=>{const l=CONFIG.crucible.abilities[a].label,o="saves"===i?n?.save:n?.mod;return{id:`${t}-${a}`,name:this.abbreviateSkills?h.capitalize(a):l,icon1:"checks"!==i?this.#g(s[a].proficient):"",info1:this.actor?{text:e.api.Utils.getModifier(o),title:`${game.i18n.localize("crucible.ActionAbil")}: ${e.api.Utils.getModifier(o)}`}:null,info2:this.actor&&"abilities"===i?{text:`(${e.api.Utils.getModifier(n?.save)})`,title:`${game.i18n.localize("crucible.SavingThrow")}: ${e.api.Utils.getModifier(n?.save)}`}:null,listName:this.#b(t,l),system:{actionType:t,actionId:a}}}));this.addActions(a,{id:i})}async buildActivations(e){const{groupData:t,actionData:i,actionType:s="item"}=e,n=new Map;for(const[e,t]of i){const i=t.system?.activities?.contents[0]?.activation?.type,s=a[i]?.group??"other";n.has(s)||n.set(s,new Map),n.get(s).set(e,t)}for(const e of Object.values(a)){const i=e.group;if(!n.has(i))continue;const a={...t,id:`${i}+${t.id}`,type:"system-derived"};["equipped","unequipped"].includes(t.id)&&(a.defaultSelected=!1);const l={id:i,type:"system"};await this.addGroup(a,l),"spell"===s&&this.addGroupInfo(a),await this.buildActions({groupData:a,actionData:n.get(i),actionType:s})}}#c(){const t={initiative:"tokenActionHud.crucible.rollInitiative",...game.combat?.current?.tokenId===this.token?.id&&{endTurn:"tokenActionHud.endTurn"}},i=e.api.Utils.getControlledTokens(),s=i?.map((e=>e.id)),a=game.combat?game.combat.combatants.filter((e=>s.includes(e.tokenId))):[],getInfo1=e=>{if("initiative"===e&&1===a.length){return{class:"tah-spotlight",text:a[0].initiative}}return{}},n="utility",l=Object.entries(t).map((([e,t])=>({id:e,name:game.i18n.localize(t),info1:getInfo1(e),cssClass:"initiative"===e?"toggle"+(a.length>0&&a.every((e=>e?.initiative))?" active":""):"",listName:this.#b(n,t),system:{actionType:n,actionId:e}})));this.addActions(l,{id:"combat"})}#o(){const e=this.actor?.actions;if(0===e.length)return;const t="action",i=Object.entries(e).map((([e,i])=>{const s=i.name;return{id:e,name:s,listName:this.#b(t,s),system:{actionType:t,actionId:i.id}}}));this.addActions(i,{id:"actions"})}async#l(){if(0===this.tokens?.length)return;const t=CONFIG.statusEffects.filter((e=>""!==e.id));if(0===t.length)return;const i="condition",s=await Promise.all(t.map((async t=>{const s=this.actors.every((e=>e.effects.some((e=>e.statuses.some((e=>e===t.id))&&!e?.disabled)))),a=game.i18n.localize(t.label)??t.label;return{id:t.id,name:a,img:e.api.Utils.getImage(t),cssClass:"toggle"+(s?" active":""),listName:this.#b(i,a),tooltip:await this.#f(await this.#v(t.id,t.label)),system:{actionType:i,actionId:t.id}}})));this.addActions(s,{id:"conditions"})}async#k(){if(!e.api.Utils.isModuleActive(l.ID)||!l.COUNTERS[this.actor?.type])return;const t="counter";let i=game.settings.get(l.ID,l.COUNTERS[this.actor?.type])??{};i=e.api.Utils.isModuleActive(l.ID)&&Object.keys(i).length?Object.entries(i).filter((([e,t])=>t.visible)).map((([e,t])=>(t.key=e,t))):[{name:game.i18n.localize("crucible.DeathSave"),type:"successFailure",system:!0,visible:!0,key:"death-saves"},{name:game.i18n.localize("crucible.Exhaustion"),type:"number",system:!0,visible:!0,key:"exhaustion"},{name:game.i18n.localize("crucible.Inspiration"),type:"checkbox",system:!0,visible:!0,key:"inspiration"}];const s=i.map((i=>{let s="",a="",n="",o="";if(i.system)switch(i.key){case"exhaustion":s=this.actor.system.attributes.exhaustion>0?" active":"",a=`toggle${s}`,n=e.api.Utils.getImage("modules/token-action-hud-crucible/icons/exhaustion.svg"),o={text:this.actor.system.attributes.exhaustion};break;case"death-saves":n=e.api.Utils.getImage("modules/token-action-hud-crucible/icons/death-saves.svg"),o={text:`${this.actor.system.attributes.death.success}/${this.actor.system.attributes.death.failure}`};break;case"inspiration":s=this.actor.system.attributes.inspiration?" active":"",a=`toggle${s}`,n=e.api.Utils.getImage("modules/token-action-hud-crucible/icons/inspiration.svg")}else{const e=this.actor.getFlag(l.ID,i.key);switch(i.type){case"checkbox":s=e?" active":"",a=`toggle${s}`;break;case"fraction":s=e.value>0?" active":"",a=`toggle${s}`,o={text:`${e.value??0}/${e.max??0}`};break;case"number":s=e>0?" active":"",a=`toggle${s}`,o={text:e};break;case"successFailure":o={text:`${e?.success??0}/${e?.failure??0}`}}}return{id:i.key,name:i.label,listName:this.#b(t,i.name),cssClass:a,img:n,info1:o,system:{actionType:t,counterKey:i.key,counterType:i.type}}}));this.addActions(s,{id:"counters"})}async#u(){const e="effect",t=new Map(this.actor.allApplicableEffects().map((e=>[e.id,e])));if(0===t.size)return;const i=new Map,s=new Map,a=new Set(CONFIG.statusEffects.map((e=>e._id)));for(const[e,n]of t.entries())n.isSuppressed||(!1!==n.parent?.system?.identified||game.user.isGM)&&(a.has(n.id)||(n.isTemporary?s.set(e,n):i.set(e,n)));await Promise.all([this.buildActions({groupData:{id:"passive-effects"},actionData:i,actionType:e}),this.buildActions({groupData:{id:"temporary-effects"},actionData:s,actionType:e})])}#A(){if(!this.actors.every((e=>"character"===e.type)))return;const t="exhaustion",i=this.actor.system.attributes.exhaustion>0?" active":"",s=[{id:"exhaustion",name:game.i18n.localize("crucible.Exhaustion"),cssClass:`toggle${i}`,img:e.api.Utils.getImage("modules/token-action-hud-crucible/icons/exhaustion.svg"),info1:{text:this.actor.system.attributes.exhaustion},listName:this.#b(t,name),system:{actionType:t,actionId:"exhaustion"}}];this.addActions(s,{id:"exhaustion"})}async#p(){const e=new Map([...this.items].filter((([,e])=>"feat"===e.type)));if(0===e.size)return;const t=new Map([["activeFeatures",new Map],["passiveFeatures",new Map]]),i={background:"backgroundFeatures",class:"classFeatures",monster:"monsterFeatures",race:"raceFeatures",feats:"feats"},s={artificerInfusion:"artificerInfusions",channelDivinity:"channelDivinity",defensiveTactic:"defensiveTactics",eldritchInvocation:"eldritchInvocations",elementalDiscipline:"elementalDisciplines",fightingStyle:"fightingStyles",huntersPrey:"huntersPrey",ki:"kiAbilities",maneuver:"maneuvers",metamagic:"metamagicOptions",multiattack:"multiattacks",pact:"pactBoons",psionicPower:"psionicPowers",rune:"runes",superiorHuntersDefense:"superiorHuntersDefense"};for(const[a,n]of e){const e=n.system.activities.contents[0]?.type,l=n.system.type.value,o=n.system.type?.subtype;e?t.get("activeFeatures").set(a,n):t.get("passiveFeatures").set(a,n),i[l]&&(t.has(i[l])||t.set(i[l],new Map),t.get(i[l]).set(a,n)),s[o]&&(t.has(s[o])||t.set(s[o],new Map),t.get(s[o]).set(a,n))}for(const e of o){const i=t.get(e);if(!i||0===i.size)continue;const s={id:c[e].id,name:game.i18n.localize(c[e].name)??""},a="feature";await this.buildActions({groupData:s,actionData:i,actionType:a}),await this.buildActivations({groupData:s,actionData:i,actionType:a})}}async#d(){if(0===this.items.size)return;const e=new Map([["equipped",new Map],["unequipped",new Map],["consumables",new Map],["containers",new Map],["equipment",new Map],["loot",new Map],["tools",new Map],["weapons",new Map]]);for(const[t,i]of this.items)if(i.system?.quantity>0&&this.#I(i)&&(i.system.equipped?e.get("equipped").set(t,i):e.get("unequipped").set(t,i),this.#S(i)&&"consumable"===i.type&&e.get("consumables").set(t,i),this.#w(i)))switch(i.type){case"container":e.get("containers").set(t,i);break;case"equipment":e.get("equipment").set(t,i);break;case"loot":e.get("loot").set(t,i);break;case"tool":e.get("tools").set(t,i);break;case"weapon":e.get("weapons").set(t,i)}for(const t of this.inventorygroupIds){const i=e.get(t);if(!i||0===i.size)continue;const s={groupData:{id:t,name:game.i18n.localize(c[t].name)},actionData:i};await this.buildActions(s),await this.buildActivations(s)}}#h(){if(0===this.actors.length||!this.actors.every((e=>"character"===e.type)))return;const e="utility",t=Object.entries({shortRest:"crucible.ShortRest",longRest:"crucible.LongRest"}).map((([t,i])=>({id:t,name:i=game.i18n.localize(i),listName:this.#b(e,i),system:{actionType:e,actionId:t}})));this.addActions(t,{id:"rests"})}#y(){const t=this.actor?.system.skills||CONFIG.crucible.skills;if(0===t.length)return;const i="skill",s=Object.entries(t).map((([t,s])=>{try{const a=CONFIG.crucible.skills[t].label;return{id:t,name:this.abbreviateSkills?h.capitalize(t):a,icon1:this.#g(s.value),info1:this.actor?{text:e.api.Utils.getModifier(s.total)}:"",listName:this.#b(i,a),system:{actionType:i,actionId:t}}}catch(t){return e.api.Logger.error(s),null}})).filter((e=>!!e));this.addActions(s,{id:"skills"})}async#H(){const e=new Map([...this.items].filter((([,e])=>"spell"===e.type)));if(0===e.size)return;const t=new Map([["atWillSpells",new Map],["innateSpells",new Map],["pactSpells",new Map],["cantrips",new Map],["_1stLevelSpells",new Map],["_2ndLevelSpells",new Map],["_3rdLevelSpells",new Map],["_4thLevelSpells",new Map],["_5thLevelSpells",new Map],["_6thLevelSpells",new Map],["_7thLevelSpells",new Map],["_8thLevelSpells",new Map],["_9thLevelSpells",new Map]]);for(const[i,s]of e)if(this.#S(s)&&this.#C(s))switch(s.system.preparation.mode){case"atwill":t.get("atWillSpells").set(i,s);break;case"innate":t.get("innateSpells").set(i,s);break;case"pact":t.get("pactSpells").set(i,s);break;default:switch(s.system.level){case 0:t.get("cantrips").set(i,s);break;case 1:t.get("_1stLevelSpells").set(i,s);break;case 2:t.get("_2ndLevelSpells").set(i,s);break;case 3:t.get("_3rdLevelSpells").set(i,s);break;case 4:t.get("_4thLevelSpells").set(i,s);break;case 5:t.get("_5thLevelSpells").set(i,s);break;case 6:t.get("_6thLevelSpells").set(i,s);break;case 7:t.get("_7thLevelSpells").set(i,s);break;case 8:t.get("_8thLevelSpells").set(i,s);break;case 9:t.get("_9thLevelSpells").set(i,s)}}const i=Object.entries(this.actor.system.spells).reverse(),s=new Map;let a=this.showUnchargedItems,n=this.showUnchargedItems,l=null;for(const[e,t]of i){const i=t.value>0,o=t.max>0,c=t.level>0;"pact"===e?(n=n||i&&o&&c,t.slotAvailable=n&&c,l=[e,t]):e.startsWith("spell")&&"spell0"!==e?(a=a||i&&o,t.slotAvailable=a,s.set(e,t)):i&&(t.slotsAvailable=!0,s.set(e,t))}if(l[1].slotAvailable){s.get(`spell${l[1].level}`).slotsAvailable=!0}const o=new Set([1,2,3,4,5,6,7,8,9,"pact"]);for(const e of m){if(!t.has(e))continue;const i=c[e].spellMode,a="pact"===i?l[1]:s.get(`spell${i}`),{value:n=0,max:r=0,slotAvailable:u=!1}=a||{};if(!u&&o.has(i))continue;const p={id:c[e].id,name:game.i18n.localize(c[e].name),info:{info1:{class:"tah-spotlight",text:r>0?`${n}/${r}`:""}}};this.addGroupInfo(p);const d={groupData:p,actionData:t.get(e),actionType:"spell"};await this.buildActions(d),await this.buildActivations(d)}}#r(){if(0===this.actors.length)return;if(!this.actors.every((e=>"character"===e.type)))return;const e="utility",t={deathSave:{name:game.i18n.localize("crucible.DeathSave")},inspiration:{name:game.i18n.localize("crucible.Inspiration")}};(!this.actor||this.actor.system.attributes.hp.value>0)&&delete t.deathSave;const i=Object.entries(t).map((t=>{const i=t[0],s=t[1].name;let a="";if("inspiration"===t[0]){a=`toggle${this.actors.every((e=>e.system.attributes?.inspiration))?" active":""}`}return{id:i,name:s,cssClass:a,listName:this.#b(e,s),system:{actionType:e,actionId:i}}}));this.addActions(i,{id:"utility"})}async buildActions(e,t){const{actionData:i,groupData:s,actionType:a}=e;if(0===i.size)return;if(!("string"==typeof s?s:s?.id))return;const n=await Promise.all([...i].map((async e=>await this.#T(e[1],a))));this.addActions(n,s)}async#T(t,i="item"){const s=t.id??t._id;let a=t?.name??t?.label,n="";if(Object.hasOwn(t,"disabled")){n=`toggle${t.disabled?"":" active"}`}const l=this.#$(t),o=await this.#f(await this.#U(t));return{id:s,name:a,cssClass:n,img:e.api.Utils.getImage(t),icon1:this.#_(t.system?.activities?.contents[0]?.activation.type),icon2:this.#L(t),icon3:this.#M(t),info1:l?.info1,info2:l?.info2,info3:l?.info3,listName:this.#b(i,a),tooltip:o,system:{actionType:i,actionId:s}}}#I(e){return!1}#w(e){return this.showUnequippedItems&&!["consumable","spell","feat"].includes(e.type)||e.system.equipped&&"consumable"!==e.type}#S(e){return this.showUnchargedItems||!!e.system.uses?.value||!e.system.uses?.max}#C(e){if("character"!==this.actor?.type&&this.showUnequippedItems)return!0;if(this.showUnpreparedSpells)return!0;return new Set(Object.keys(CONFIG.crucible.spellPreparationModes).filter((e=>"prepared"!==e))).has(e.system.preparation.mode)||e.system.preparation.prepared}#b(e,t){return`${`${game.i18n.localize(s[e])}: `??""}${t}`??""}#$(e){return{info1:"spell"===e.type?this.#D(e):this.#x(e),info2:this.#z(e),info3:this.#E(e)}}#D(e){if(!this.displaySpellInfo)return null;const t=e.system?.properties;if(!t)return null;const i={text:"",title:""},s=Object.entries({vocal:"crucible.ComponentVerbal",somatic:"crucible.ComponentSomatic",material:"crucible.ComponentMaterial"}).filter((([e])=>t[e])).map((([e,t])=>(i.text+=game.i18n.localize(`${t}Abbr`),game.i18n.localize(t))));return t.ritual&&(s.push(`[${game.i18n.localize("crucible.Ritual")}]`),i.text+=` [${game.i18n.localize("crucible.RitualAbbr")}]`),i.title=s.join(", "),i}#e(){const e=["character","npc"];return this.actors.every((t=>e.includes(t.type)))?this.actors:[]}#t(){const e=["character","npc"];return this.actors.every((t=>e.includes(t.type)))?this.tokens:[]}#x(e){const t=e?.system?.quantity??0;return{text:t>1?t:"",title:`${game.i18n.localize("crucible.Quantity")}: ${t}`}}#z(e){const t=e?.system?.uses;if(!(t?.max>0))return{};const i="charges"===t.recovery[0]?.period?"":` ${game.i18n.localize("crucible.per")} `,s=CONFIG.crucible.limitedUsePeriods[t.recovery[0]?.period]?.label??t.recovery[0]?.period,a=s?`${i}${s}`:"",n=`${t.max-(t.spent??0)}/${t.max}`;return{text:n,title:`${n}${a}`}}#E(e){const t=e?.system?.activities?.contents[0],i=t?.consumption?.targets?.[0],s=i?.target,a=i?.type,n=i?.value;if(!s||!a||s===e.id)return{};if("attribute"===a){const e=s.substr(0,s.lastIndexOf(".")),t=foundry.utils.getProperty(this.actor.system,e);if(t){const e=`${t.value??"0"}${t.max?`/${t.max}`:""}`;return{text:e,title:`${e} ${t.label??""}`}}}else{const e=this.actor.items?.get(s);if(e&&"charges"===a)return this.#z(e);if(e?.system?.quantity){const t=`${n>1?`${n} ${game.i18n.localize("crucible.of")} `:""}${e.system.quantity}`;return{text:t,title:`${t} ${e.name}`}}}return{}}#i(e){if(h.getSetting("showSlowActions"))return e;const t=new Set(["minute","hour","day"]);return new Map([...e.entries()].filter((([e,i])=>{const s=i.system?.activation?.type;return!t.has(s)})))}#g(e){const t=CONFIG.crucible.proficiencyLevels[e]??"",i=u[e];return i?`<i class="${i}" title="${t}"></i>`:""}#_(e){const t=CONFIG.crucible.abilityActivationTypes[e]??"",i=a[e]?.icon;return i?`<i class="${i}" title="${t}"></i>`:""}#M(e){if("spell"!==e?.type||!this.displaySpellInfo||!e.system?.properties?.has("concentration"))return null;const t=game.i18n.localize("crucible.Scroll.RequiresConcentration");return`<crucible-icon src="${n}" title="${t}">`}#L(e){if("spell"!==e?.type||!this.showUnpreparedSpells)return null;const t=e.system.level,i=e.system.preparation.mode,s=e.system.preparation.prepared,a=s?r:`${r} tah-icon-disabled`,n="always"===i?game.i18n.localize("crucible.SpellPrepAlways"):s?game.i18n.localize("crucible.SpellPrepared"):game.i18n.localize("crucible.SpellUnprepared");return"prepared"!==i&&"always"!==i||0===t?null:`<i class="${a}" title="${n}"></i>`}async#U(e){if("none"===this.tooltipsSetting)return"";const t=e?.name??"";if("nameOnly"===this.tooltipsSetting)return t;const i=!1===e.system?.identified,s="string"==typeof e?.system?.description?e?.system?.description:(i?e?.system?.unidentified?.description:e?.system?.description?.value)??"";let a,n,l,o;return i||(a=e?.modifiers??null,n=[...e.system?.chatProperties??[],...e.system?.equippableItemCardProperties??[],e.system?.parent?.labels?.activation,e.system?.parent?.labels?.target,e.system?.parent?.labels?.range,e.system?.parent?.labels?.duration].filter((e=>e)),l=i?null:e?.rarity??null,o="weapon"===e?.type?this.#F(e?.system?.properties):null),{name:t,description:s,modifiers:a,properties:n,rarity:l,traits:o}}async#v(e,t){if("none"===this.tooltipsSetting)return"";const i=CONFIG.statusEffects.find((t=>t.id===e));if("nameOnly"===this.tooltipsSetting||!i)return t;const s=i.reference?await fromUuid(i.reference):null;return{label:t,description:s?.text?.content??"",relativeTo:s}}async#f(e){if("none"===this.tooltipsSetting)return"";if("string"==typeof e)return e;const t=game.i18n.localize(e.name);if("nameOnly"===this.tooltipsSetting)return t;const i=`<h3>${t}</h3>`,s=e.relativeTo??this.actor,a=e?.descriptionLocalised??await TextEditor.enrichHTML(game.i18n.localize(e?.description??""),{async:!0,relativeTo:s,secrets:!0}),n=e?.rarity?`<span class="tah-tag ${e.rarity}">${game.i18n.localize(p[e.rarity])}</span>`:"",l=e?.properties?`<div class="tah-properties">${e.properties.map((e=>`<span class="tah-property">${game.i18n.localize(e)}</span>`)).join("")}</div>`:"",o=e?.traits?e.traits.map((e=>`<span class="tah-tag">${game.i18n.localize(e.label??e)}</span>`)).join(""):"",c=e?.traits2?e.traits2.map((e=>`<span class="tah-tag tah-tag-secondary">${game.i18n.localize(e.label??e)}</span>`)).join(""):"",r=e?.traitsAlt?e.traitsAlt.map((e=>`<span class="tah-tag tah-tag-alt">${game.i18n.localize(e.label)}</span>`)).join(""):"",u=e?.modifiers?`<div class="tah-tags">${e.modifiers.filter((e=>e.enabled)).map((e=>`<span class="tah-tag tah-tag-transparent">${game.i18n.localize(e.label)} ${`${e.modifier>=0?"+":""}${e.modifier??""}`}</span>`)).join("")}</div>`:"",d=[n,o,c,r].join(""),m=d?`<div class="tah-tags">${d}</div>`:"";return a||m||u?`<div>${i}${m||u?`<div class="tah-tags-wrapper">${m}${u}</div>`:""}${a}${l}</div>`:t}#F(e){return e?Object.entries(e).filter((([e,t])=>t&&CONFIG.crucible.validProperties.weapon.has(e))).map((([e,t])=>game.i18n.localize(CONFIG.crucible.itemProperties[e]))):null}}}));let g=null;Hooks.once("tokenActionHudCoreApiReady",(async e=>{const t=c;Object.values(t).forEach((t=>{t.name=e.api.Utils.i18n(t.name),t.listName=`Group: ${e.api.Utils.i18n(t.name)}`}));const i=Object.values(t);g={layout:[{nestId:"actions",id:"actions",name:e.api.Utils.i18n("ACTOR.TABS.ACTIONS"),groups:[{...t.actions,nestId:"actions_actions"}]},{nestId:"inventory",id:"inventory",name:e.api.Utils.i18n("ACTOR.TABS.INVENTORY"),groups:[{...t.weapons,nestId:"inventory_weapons"},{...t.equipment,nestId:"inventory_equipment"},{...t.consumables,nestId:"inventory_consumables"},{...t.tools,nestId:"inventory_tools"},{...t.containers,nestId:"inventory_containers"},{...t.loot,nestId:"inventory_loot"}]},{nestId:"features",id:"features",name:e.api.Utils.i18n("ACTOR.TABS.SKILLS"),groups:[{...t.activeFeatures,nestId:"features_active-features"},{...t.passiveFeatures,nestId:"features_passive-features"}]},{nestId:"spells",id:"spells",name:e.api.Utils.i18n("TYPES.Item.spellPl"),groups:[{...t.atWillSpells,nestId:"spells_at-will-spells"},{...t.innateSpells,nestId:"spells_innate-spells"},{...t.pactSpells,nestId:"spells_pact-spells"},{...t.cantrips,nestId:"spells_cantrips"},{...t._1stLevelSpells,nestId:"spells_1st-level-spells"},{...t._2ndLevelSpells,nestId:"spells_2nd-level-spells"},{...t._3rdLevelSpells,nestId:"spells_3rd-level-spells"},{...t._4thLevelSpells,nestId:"spells_4th-level-spells"},{...t._5thLevelSpells,nestId:"spells_5th-level-spells"},{...t._6thLevelSpells,nestId:"spells_6th-level-spells"},{...t._7thLevelSpells,nestId:"spells_7th-level-spells"},{...t._8thLevelSpells,nestId:"spells_8th-level-spells"},{...t._9thLevelSpells,nestId:"spells_9th-level-spells"}]},{nestId:"attributes",id:"attributes",name:e.api.Utils.i18n("ACTOR.TABS.ATTRIBUTES"),groups:[{...t.abilities,nestId:"attributes_abilities"},{...t.skills,nestId:"attributes_skills"}]},{nestId:"effects",id:"effects",name:e.api.Utils.i18n("ACTOR.TABS.EFFECTS"),groups:[{...t.temporaryEffects,nestId:"effects_temporary-effects"},{...t.passiveEffects,nestId:"effects_passive-effects"},{...t.conditions,nestId:"effects_conditions"}]},{nestId:"utility",id:"utility",name:e.api.Utils.i18n("tokenActionHud.utility"),groups:[{...t.combat,nestId:"utility_combat"},{...t.token,nestId:"utility_token"},{...t.rests,nestId:"utility_rests"},{...t.utility,nestId:"utility_utility"}]}],groups:i}}));let b=null;function register(t){game.settings.register(e.ID,"abbreviateSkills",{name:game.i18n.localize("tokenActionHud.crucible.settings.abbreviateSkills.name"),hint:game.i18n.localize("tokenActionHud.crucible.settings.abbreviateSkills.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:e=>{t(e)}}),game.settings.register(e.ID,"showSlowActions",{name:game.i18n.localize("tokenActionHud.crucible.settings.showSlowActions.name"),hint:game.i18n.localize("tokenActionHud.crucible.settings.showSlowActions.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:e=>{t(e)}}),game.settings.register(e.ID,"displaySpellInfo",{name:game.i18n.localize("tokenActionHud.crucible.settings.displaySpellInfo.name"),hint:game.i18n.localize("tokenActionHud.crucible.settings.displaySpellInfo.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:e=>{t(e)}}),game.settings.register(e.ID,"showUnchargedItems",{name:game.i18n.localize("tokenActionHud.crucible.settings.showUnchargedItems.name"),hint:game.i18n.localize("tokenActionHud.crucible.settings.showUnchargedItems.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:e=>{t(e)}}),game.settings.register(e.ID,"showUnequippedItems",{name:game.i18n.localize("tokenActionHud.crucible.settings.showUnequippedItems.name"),hint:game.i18n.localize("tokenActionHud.crucible.settings.showUnequippedItems.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:e=>{t(e)}}),game.settings.register(e.ID,"showUnequippedItemsNpcs",{name:game.i18n.localize("tokenActionHud.crucible.settings.showUnequippedItemsNpcs.name"),hint:game.i18n.localize("tokenActionHud.crucible.settings.showUnequippedItemsNpcs.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:e=>{t(e)}}),game.settings.register(e.ID,"showUnpreparedSpells",{name:game.i18n.localize("tokenActionHud.crucible.settings.showUnpreparedSpells.name"),hint:game.i18n.localize("tokenActionHud.crucible.settings.showUnpreparedSpells.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:e=>{t(e)}}),game.settings.register(e.ID,"showItemsWithoutActivationCosts",{name:game.i18n.localize("tokenActionHud.crucible.settings.showItemsWithoutActivationCosts.name"),hint:game.i18n.localize("tokenActionHud.crucible.settings.showItemsWithoutActivationCosts.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:e=>{t(e)}})}Hooks.once("tokenActionHudCoreApiReady",(async e=>{b=class RollHandler extends e.api.RollHandler{async handleActionClick(t){const{actionType:i,actionId:s}=this.action.system;if(this.actor)await this.handleAction(t,i,this.actor,this.token,s);else for(const a of e.api.Utils.getControlledTokens()){const e=a.actor;await this.handleAction(t,i,e,a,s)}}async handleAction(e,t,i,s,a){switch(t){case"action":i.actions[a].use();break;case"ability":this.rollAbility(e,i,a);break;case"check":this.rollAbilityTest(e,i,a);break;case"save":this.rollAbilitySave(e,i,a);break;case"condition":if(!s)return;await this.toggleCondition(i,s,a);break;case"counter":await this.modifyCounter(e,i);break;case"effect":await this.toggleEffect(i,a);break;case"exhaustion":await this.modifyExhaustion(e,i);break;case"feature":case"item":case"spell":case"weapon":this.isRenderItem()?this.renderItem(i,a):this.useItem(e,i,a);break;case"magicItem":await this.rollMagicItem(i,a);break;case"skill":this.rollSkill(e,i,a);break;case"utility":await this.performUtilityAction(e,i,s,a)}}async modifyCounter(e,t){switch(this.action?.system?.counterKey){case"death-saves":this.rollDeathSave(e,t);break;case"exhaustion":await this.modifyExhaustion(t);break;case"inspiration":await this.modifyInspiration(t);break;default:await this.modifyCustomCounter(t)}}async modifyExhaustion(e){const t=e.system.attributes.exhaustion,i=t+(this.isRightClick?-1:1);i>=0&&i!==t&&e.update({"system.attributes.exhaustion":i})}async modifyInspiration(e){const t=!e.system.attributes.inspiration;e.update({"system.attributes.inspiration":t})}async modifyCustomCounter(e){const{counterKey:t,counterType:i}=this.action.system;let s=e.getFlag(l.ID,t)||{};const setFlag=async(t,i,s)=>{s!==i&&await e.setFlag(l.ID,t,s)},adjustValue=(e,t=0,i=1)=>{const s=this.isRightClick?Math.max(0,t-i):t+i;setFlag(e,t,s)};switch(i){case"checkbox":await setFlag(id,!s);break;case"fraction":(this.isRightClick||s.max&&s.value<s.max||!s.max)&&adjustValue(`${id}.value`,s.value);break;case"number":adjustValue(id,s);break;case"successFailure":s.success=s?.success??0,s.failure=s?.failure??0,this.isCtrl?adjustValue(`${id}.failure`,s.failure):adjustValue(`${id}.success`,s.success)}}rollAbility(e,t,i){t.system?.abilities&&t.rollAbility(i,{event:e})}rollAbilitySave(e,t,i){t.system?.abilities&&t.rollAbilitySave(i,{event:e})}rollAbilityTest(e,t,i){t.system?.abilities&&t.rollAbilityTest(i,{event:e})}rollDeathSave(e,t){t.rollDeathSave({event:e})}async rollMagicItem(e){const{itemId:t,effectId:i}=this.action.system,s=await MagicItems.actor(e.id);s&&(s.roll(t,i),Hooks.callAll("forceUpdateTokenActionHud"))}rollSkill(e,t,i){t.system?.skills&&t.rollSkill(i,{event:e})}useItem(t,i,s){const a=e.api.Utils.getItem(i,s);this.#O(a)?a.rollRecharge():a.use({event:t,legacy:!1})}#O(e){return"recharge"===e?.system?.uses?.period&&!(e?.system?.uses?.value>0)}async performUtilityAction(e,t,i,s){switch(s){case"deathSave":this.rollDeathSave(e,t);break;case"endTurn":if(!i||game.combat?.current?.tokenId!==i.id)break;await(game.combat?.nextTurn());break;case"initiative":await this.rollInitiative(t);break;case"inspiration":await this.modifyInspiration(t);break;case"longRest":t.longRest();break;case"shortRest":t.shortRest()}Hooks.callAll("forceUpdateTokenActionHud")}async rollInitiative(e){e&&(await e.rollInitiative({createCombatants:!0}),Hooks.callAll("forceUpdateTokenActionHud"))}async toggleCondition(e,t,i){if(!t)return;const s=CONFIG.statusEffects.find((e=>e.id===i)),a=s?.flags?.["dfreds-convenient-effects"]?.isConvenient??i.startsWith("Convenient Effect");if(game.dfreds&&a){const e=s.name??s.label;await game.dfreds.effectInterface.toggleEffect(e,{overlay:!!this.isRightClick})}else{const t=this.#P(i);if(!t)return;const s=this.#q(e,i);s?.disabled&&await s.delete(),await e.toggleStatusEffect(t.id,{active:s?.disabled??!0,overlay:!!this.isRightClick})}Hooks.callAll("forceUpdateTokenActionHud")}#P(e){return CONFIG.statusEffects.find((t=>t.id===e))}#q(e,t){return e.effects.find((e=>e.statuses.every((e=>e===t))))}async toggleEffect(e,t){const i=e.allApplicableEffects().find((e=>e.id===t));i&&(this.isRightClick&&!i.transfer?await i.delete():await i.update({disabled:!i.disabled}),Hooks.callAll("forceUpdateTokenActionHud"))}async handleActionHover(t){const{actionType:i,actionId:s}=this.action.system;if(!["feature","item","spell","weapon","magicItem"].includes(i))return;const a=e.api.Utils.getItem(this.actor,s);this.isHover?Hooks.call("tokenActionHudSystemActionHoverOn",t,a):Hooks.call("tokenActionHudSystemActionHoverOff",t,a)}}}));let f=null;Hooks.once("tokenActionHudCoreApiReady",(async e=>{f=class SystemManager extends e.api.SystemManager{getActionHandler(){return new y}getAvailableRollHandlers(){return{core:"Core Crucible"}}getRollHandler(e){let t;return t=new b,t}registerSettings(e){register(e)}async registerDefaults(){return g}}})),Hooks.on("tokenActionHudCoreApiReady",(async()=>{const t=game.modules.get(e.ID);t.api={requiredCoreModuleVersion:"2.0",SystemManager:f},Hooks.call("tokenActionHudSystemReady",t)}));export{s as ACTION_TYPE,a as ACTIVATION_TYPE,y as ActionHandler,n as CONCENTRATION_ICON,t as CORE_MODULE,l as CUSTOM_crucible,g as DEFAULTS,o as FEATURE_GROUP_IDS,c as GROUP,e as MODULE,r as PREPARED_ICON,u as PROFICIENCY_LEVEL_ICON,p as RARITY,i as REQUIRED_CORE_MODULE_VERSION,d as RITUAL_ICON,b as RollHandler,m as SPELL_GROUP_IDS,f as SystemManager,h as Utils,register};
//# sourceMappingURL=token-action-hud-crucible.min.js.map
